name: gemini-headless-check

on:
  workflow_dispatch:
  pull_request:

jobs:
  gemini:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Gemini CLI
        run: npm i -g @google/gemini-cli
      - name: Headless plan → execute → verify
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          gemini -p "在此專案中執行單元測試並彙整失敗重現步驟" --include-directories . --output-format json > gemini-report.json
          test -s gemini-report.json
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: gemini-report
          path: gemini-report.json